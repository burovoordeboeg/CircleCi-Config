# ENV Variables
# $VPN_CLIENT_CONFIG = Base64 encoded OVPN

version: 2.1
workflows:
  btd:
    jobs:
      - build

jobs:
  build:
    docker:
      - image: circleci/php:7.3-stretch-node-browsers
    steps:
      - run:
          name: Install OpenVPN and Rsync
          command: |
            sudo apt-get update
            sudo apt-get install openvpn -y
            sudo apt-get install rsync -y

      - run:
          name: Connect through VPN
          command: >
            echo $VPN_CLIENT_CONFIG | base64 --decode >> config.ovpn

            wget -qO- http://checkip.amazonaws.com | tee initial.ip

            sudo openvpn --config config.ovpn >
            openvpn.log 2>&1 &
    
            while [ -n "$(ip addr show tun0 2>&1 > /dev/null)" ]; do
              sleep 0.1;
            done
    
            cat openvpn.log
    
            wget -qO- http://checkip.amazonaws.com | tee final.ip
    
            if [ "$(cat initial.ip)" == "$(cat final.ip)" ]
    
            then
              echo "This computer's apparent public IP address was not different after connecting"
              echo "This may mean that your VPN is not configured correctly."
              exit 1
            fi
    
      - checkout

      - add_ssh_keys:
          fingerprints:
            - "$SSH_FINGERPRINT"

      - run:
          name: Add server keys
          command: ssh-keyscan $SERVER_IP >> ~/.ssh/known_hosts

      - run:
          name: Rsync deploy to staging
          command:  rsync -avzp --chown=$USER:$USER --delete --exclude-from '.rsyncignore' . $USER@$SERVER_IP:/home/$USER/domains/$PRODUCTION_PATH

      - run:
          name: Disconnect from OpenVPN
          command: sudo killall openvpn || true
          when: always